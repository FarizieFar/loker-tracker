

{% extends 'base-sidebar.html' %}

{% block title %}Dashboard - Loker Tracker{% endblock %}

{% block breadcrumb %}
    <li class="breadcrumb-item active">Dashboard</li>
{% endblock %}

{% block content %}

<!-- Clean Modern Page Header -->
<div class="page-header">
    <div class="d-flex justify-content-between align-items-center flex-wrap" style="gap: var(--space-4);">
        <div>
            <h1 class="page-title">
                <i class="fas fa-chart-line me-3"></i>
                Dashboard Overview
            </h1>
            <p class="page-subtitle">
                Kelola dan lacak lamaran kerja Anda dengan mudah dan efisien
            </p>
        </div>
        <div class="action-buttons">
            <a href="{{ url_for('export_pdf') }}" class="btn btn-danger">
                <i class="fas fa-file-pdf me-2"></i>Export PDF
            </a>
            <a href="{{ url_for('export_excel') }}" class="btn btn-success">
                <i class="fas fa-file-excel me-2"></i>Export Excel
            </a>
            <a href="{{ url_for('add_job') }}" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Tambah Lamaran
            </a>
        </div>
    </div>
</div>

<!-- Modern Statistics Cards -->
<div class="stats-grid">
    <!-- Total Lamaran Card -->
    <div class="stat-card">
        <div class="stat-icon primary">
            <i class="fas fa-briefcase"></i>
        </div>
        <div class="stat-number" data-stat="total">{{ total }}</div>
        <div class="stat-label">Total Lamaran</div>
    </div>

    <!-- Status Cards -->
    <div class="stat-card">
        <div class="stat-icon gray">
            <i class="fas fa-clock"></i>
        </div>
        <div class="stat-number" data-stat="terdaftar">{{ terdaftar }}</div>
        <div class="stat-label">Terdaftar</div>
    </div>

    <div class="stat-card">
        <div class="stat-icon warning">
            <i class="fas fa-calendar-check"></i>
        </div>
        <div class="stat-number" data-stat="interview">{{ interview }}</div>
        <div class="stat-label">Interview</div>
    </div>

    <div class="stat-card">
        <div class="stat-icon primary">
            <i class="fas fa-clipboard-list"></i>
        </div>
        <div class="stat-number" data-stat="tes">{{ tes }}</div>
        <div class="stat-label">Tes</div>
    </div>

    <div class="stat-card">
        <div class="stat-icon success">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-number" data-stat="diterima">{{ diterima }}</div>
        <div class="stat-label">Diterima</div>
    </div>

    <div class="stat-card">
        <div class="stat-icon error">
            <i class="fas fa-times-circle"></i>
        </div>
        <div class="stat-number" data-stat="ditolak">{{ ditolak }}</div>
        <div class="stat-label">Tidak Diterima</div>
    </div>
</div>

<!-- Modern Filter Section -->
<div class="card filter-section">
    <div class="card-header">
        <h5 class="card-title">
            <i class="fas fa-filter me-2"></i>
            Filter & Pencarian
        </h5>
    </div>
    <div class="card-body">
        <form method="get" class="filter-form">
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-building me-2"></i>
                    Nama Perusahaan
                </label>
                <input type="text" 
                       name="q" 
                       class="form-control" 
                       placeholder="Cari nama perusahaan..." 
                       value="{{ request.args.get('q', '') }}">
            </div>
            
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-flag me-2"></i>
                    Status
                </label>
                <select name="status" class="form-select">
                    <option value="All" {% if request.args.get('status') == 'All' %}selected{% endif %}>Semua Status</option>
                    <option value="Terdaftar" {% if request.args.get('status') == 'Terdaftar' %}selected{% endif %}>Terdaftar</option>
                    <option value="Interview" {% if request.args.get('status') == 'Interview' %}selected{% endif %}>Interview</option>
                    <option value="Tes" {% if request.args.get('status') == 'Tes' %}selected{% endif %}>Tes</option>
                    <option value="Diterima" {% if request.args.get('status') == 'Diterima' %}selected{% endif %}>Diterima</option>
                    <option value="Tidak Diterima" {% if request.args.get('status') == 'Tidak Diterima' %}selected{% endif %}>Tidak Diterima</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-calendar me-2"></i>
                    Tanggal Awal
                </label>
                <input type="date" 
                       name="start_date" 
                       class="form-control" 
                       value="{{ request.args.get('start_date', '') }}">
            </div>
            
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-calendar me-2"></i>
                    Tanggal Akhir
                </label>
                <input type="date" 
                       name="end_date" 
                       class="form-control" 
                       value="{{ request.args.get('end_date', '') }}">
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-search me-2"></i>Cari
                </button>
                <a href="/" class="btn btn-secondary">
                    <i class="fas fa-refresh me-2"></i>Reset
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Modern Jobs Table -->
<div class="card table-section">
    <div class="card-header">
        <h5 class="card-title">
            <i class="fas fa-list me-2"></i>
            Daftar Lamaran Kerja
            {% if jobs|length > 0 %}
                <span class="text-muted">({{ jobs|length }} item)</span>
            {% endif %}
        </h5>
    </div>
    
    <div class="table-container">
        <table class="jobs-table">
            <thead>
                <tr>
                    <th class="text-center">
                        <i class="fas fa-hashtag"></i>
                    </th>
                    <th>
                        <i class="fas fa-building me-2"></i>
                        Perusahaan
                    </th>
                    <th>
                        <i class="fas fa-user-tie me-2"></i>
                        Posisi
                    </th>
                    <th>
                        <i class="fas fa-share-alt me-2"></i>
                        Sumber Info
                    </th>
                    <th>
                        <i class="fas fa-map-marker-alt me-2"></i>
                        Lokasi
                    </th>
                    <th>
                        <i class="fas fa-camera me-2"></i>
                        Bukti Lamaran
                    </th>
                    <th>
                        <i class="fas fa-flag me-2"></i>
                        Status
                    </th>

                    <th>
                        <i class="fas fa-calendar me-2"></i>
                        Tanggal Apply
                    </th>
                    <th>
                        <i class="fas fa-clock me-2"></i>
                        Terakhir Diupdate
                    </th>
                    <th class="text-center">
                        <i class="fas fa-cog me-2"></i>
                        Aksi
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for job in jobs %}
                <tr>
                    <td class="text-center">
                        <span class="badge bg-light text-dark fw-bold">{{ loop.index }}</span>
                    </td>
                    
                    <td data-label="Perusahaan">
                        <div class="company-name">{{ job.company_name }}</div>
                    </td>

                    <td data-label="Posisi">
                        <div class="position-info">
                            {% if job.position %}
                                <i class="fas fa-user-tie"></i>
                                {{ job.position }}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </div>
                    </td>

                    <td data-label="Sumber Info">
                        {% if job.source_info %}
                            {% if job.source_info == 'LinkedIn' %}
                                <span class="source-badge linkedin">
                                    <i class="fab fa-linkedin"></i>LinkedIn
                                </span>
                            {% elif job.source_info == 'Instagram' %}
                                <span class="source-badge instagram">
                                    <i class="fab fa-instagram"></i>Instagram
                                </span>
                            {% elif job.source_info == 'TikTok' %}
                                <span class="source-badge tiktok">
                                    <i class="fab fa-tiktok"></i>TikTok
                                </span>
                            {% elif job.source_info == 'WhatsApp' %}
                                <span class="source-badge whatsapp">
                                    <i class="fab fa-whatsapp"></i>WhatsApp
                                </span>
                            {% elif job.source_info == 'JobStreet' %}
                                <span class="source-badge jobstreet">
                                    <i class="fas fa-briefcase"></i>JobStreet
                                </span>
                            {% elif job.source_info == 'Indeed' %}
                                <span class="source-badge indeed">
                                    <i class="fas fa-search"></i>Indeed
                                </span>
                            {% elif job.source_info == 'Website Perusahaan' %}
                                <span class="source-badge website">
                                    <i class="fas fa-globe"></i>Website
                                </span>
                            {% elif job.source_info == 'Email/Newsletter' %}
                                <span class="source-badge email">
                                    <i class="fas fa-envelope"></i>Email
                                </span>
                            {% elif job.source_info == 'Teman/Kolega' %}
                                <span class="source-badge friend">
                                    <i class="fas fa-users"></i>Teman
                                </span>
                            {% elif job.source_info == 'Job Fair/Expo' %}
                                <span class="source-badge jobfair">
                                    <i class="fas fa-calendar-alt"></i>Job Fair
                                </span>
                            {% elif job.source_info == 'Media Sosial Lainnya' %}
                                <span class="source-badge social">
                                    <i class="fas fa-share-alt"></i>Social
                                </span>
                            {% elif job.source_info == 'Custom' %}
                                <span class="source-badge custom">
                                    <i class="fas fa-edit"></i>Custom
                                </span>
                            {% else %}
                                <span class="source-badge custom">
                                    <i class="fas fa-pencil-alt"></i>{{ job.source_info }}
                                </span>
                            {% endif %}
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    
                    <td data-label="Lokasi">
                        <div class="location-info">
                            <i class="fas fa-map-marker-alt"></i>
                            {{ job.location }}
                        </div>
                    </td>

                    <td data-label="Bukti Lamaran">
                        {% if job.application_proof or job.image_proof %}
                            <div style="display: flex; flex-direction: column; gap: var(--space-2);">
                                <!-- Link Bukti -->
                                {% if job.application_proof and job.application_proof.startswith('http') %}
                                    <a href="{{ job.application_proof }}" target="_blank" class="proof-link">
                                        <i class="fas fa-external-link-alt me-1"></i>
                                        Link Bukti
                                    </a>
                                {% endif %}
                                

                                <!-- Screenshot -->
                                {% if job.image_proof %}
                                    <button onclick="showImageModal('/uploads/proofs/{{ job.image_proof }}', 'Bukti Lamaran - {{ job.company_name }}')" class="btn btn-sm btn-info proof-screenshot">
                                        <i class="fas fa-image me-1"></i>
                                        Screenshot
                                    </button>
                                {% endif %}
                                
                                <!-- Jika hanya ada link tanpa http -->
                                {% if job.application_proof and not job.application_proof.startswith('http') %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </div>
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>




                    <td data-label="Status">
                        <div class="status-badge-container">

                            <span class="status-badge status-{{ (job.status.name or 'unknown').lower().replace(' ', '-') }}" data-job-id="{{ job.id }}">
                                <i class="fas fa-flag"></i>

                                {{ job.status.name if job.status else 'Status Tidak Diketahui' }}
                            </span>
                        </div>
                    </td>


                    <td data-label="Tanggal Apply">
                        <div class="date-info">
                            <i class="fas fa-calendar"></i>
                            {{ job.applied_date.strftime('%d %b %Y') }}
                        </div>
                    </td>

                    <td data-label="Terakhir Diupdate">
                        <div class="date-info">
                            <i class="fas fa-clock"></i>
                            {% if job.last_status_update %}
                                <span class="last-update-text" data-timestamp="{{ job.last_status_update.isoformat() }}">
                                    {{ job.last_status_update.strftime('%d %b %Y %H:%M') }}
                                </span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </div>
                    </td>

                    <td data-label="Aksi">
                        <div class="d-flex gap-2 justify-content-center">
                            <a href="/job/{{ job.id }}/edit" 
                               class="btn btn-warning btn-sm"
                               title="Edit data">
                                <i class="fas fa-edit me-1"></i>
                                Edit
                            </a>
                            <form method="post" action="/job/{{ job.id }}/delete" style="display: inline;">
                                <button type="submit" class="btn btn-danger btn-sm" 
                                        onclick="return confirm('Apakah Anda yakin ingin menghapus lamaran kerja dari {{ job.company_name }}?')"
                                        title="Hapus data">
                                    <i class="fas fa-trash me-1"></i>
                                    Hapus
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>

                    <td colspan="10" class="text-center py-4">
                        <div class="empty-state">
                            <i class="fas fa-inbox mb-4"></i>
                            <p class="mb-2">Belum ada data lamaran kerja</p>
                            <small>Klik "Tambah Lamaran" untuk mulai menambah data</small>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Modern Pagination -->
    {% if pagination.pages > 1 %}
    <div class="card-footer">
        <div class="pagination">
            <div class="pagination-info">
                Halaman {{ pagination.page }} dari {{ pagination.pages }}
            </div>
            <div class="pagination-links">
                <!-- First Page -->
                {% if pagination.has_prev %}
                <a class="page-btn" href="{{ url_for('index', page=1, q=request.args.get('q', ''), status=request.args.get('status', 'All'), start_date=request.args.get('start_date', ''), end_date=request.args.get('end_date', '')) }}" title="Halaman pertama">
                    <i class="fas fa-angle-double-left"></i>
                </a>
                <a class="page-btn" href="{{ url_for('index', page=pagination.prev_num, q=request.args.get('q', ''), status=request.args.get('status', 'All'), start_date=request.args.get('start_date', ''), end_date=request.args.get('end_date', '')) }}" title="Halaman sebelumnya">
                    <i class="fas fa-angle-left"></i>
                </a>
                {% endif %}
                
                <!-- Page Numbers -->
                {% for page_num in pagination.iter_pages() %}
                    {% if page_num %}
                        {% if page_num != pagination.page %}
                        <a class="page-link" href="{{ url_for('index', page=page_num, q=request.args.get('q', ''), status=request.args.get('status', 'All'), start_date=request.args.get('start_date', ''), end_date=request.args.get('end_date', '')) }}">
                            {{ page_num }}
                        </a>
                        {% else %}
                        <span class="page-current">{{ page_num }}</span>
                        {% endif %}
                    {% else %}
                    <span class="page-ellipsis">...</span>
                    {% endif %}
                {% endfor %}
                
                <!-- Next Page -->
                {% if pagination.has_next %}
                <a class="page-btn" href="{{ url_for('index', page=pagination.next_num, q=request.args.get('q', ''), status=request.args.get('status', 'All'), start_date=request.args.get('start_date', ''), end_date=request.args.get('end_date', '')) }}" title="Halaman selanjutnya">
                    <i class="fas fa-angle-right"></i>
                </a>
                <a class="page-btn" href="{{ url_for('index', page=pagination.pages, q=request.args.get('q', ''), status=request.args.get('status', 'All'), start_date=request.args.get('start_date', ''), end_date=request.args.get('end_date', '')) }}" title="Halaman terakhir">
                    <i class="fas fa-angle-double-right"></i>
                </a>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
</div>





<!-- Modern JavaScript dengan Status Dropdown -->
<script>
// Status options configuration
const STATUS_OPTIONS = [
    { value: 'Terdaftar', label: 'Terdaftar', dotClass: 'terdaftar' },
    { value: 'Interview', label: 'Interview', dotClass: 'interview' },
    { value: 'Tes', label: 'Tes', dotClass: 'tes' },
    { value: 'Diterima', label: 'Diterima', dotClass: 'diterima' },
    { value: 'Tidak Diterima', label: 'Tidak Diterima', dotClass: 'tidak-diterima' }
];


document.addEventListener('DOMContentLoaded', function() {
    // Initialize status dropdowns
    initializeStatusDropdowns();
    
    // Initialize relative time formatting
    initializeRelativeTime();
    
    // Simple confirmation for delete
    console.log('Dashboard loaded successfully');
    
    // Add smooth scrolling
    document.documentElement.style.scrollBehavior = 'smooth';
    
    // Add loading states to buttons
    const forms = document.querySelectorAll('form');
    forms.forEach(form => {
        form.addEventListener('submit', function(e) {
            const submitBtn = this.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Memproses...';
                submitBtn.disabled = true;
            }
        });
    });
});


// Initialize all status dropdowns
function initializeStatusDropdowns() {
    const statusBadges = document.querySelectorAll('.status-badge');
    console.log('Found status badges:', statusBadges.length);
    
    statusBadges.forEach((badge, index) => {
        console.log(`Initializing badge ${index}:`, badge);
        
        // Remove existing dropdown if any
        const existingDropdown = badge.querySelector('.status-dropdown');
        if (existingDropdown) {
            existingDropdown.remove();
        }
        
        createStatusDropdown(badge);
        addStatusBadgeListeners(badge);
    });
}


// Create dropdown for status badge
function createStatusDropdown(badge) {
    const dropdown = document.createElement('div');
    dropdown.className = 'status-dropdown';
    
    const currentStatus = badge.textContent.trim();
    console.log('Creating dropdown for current status:', currentStatus);
    
    dropdown.innerHTML = STATUS_OPTIONS.map(option => {
        const isActive = option.value === currentStatus;
        return `
            <div class="status-option ${isActive ? 'active' : ''}" 
                 data-status="${option.value}">
                <span class="status-dot ${option.dotClass}"></span>
                ${option.label}
            </div>
        `;
    }).join('');
    
    badge.appendChild(dropdown);
    console.log('Dropdown created and appended');
}

// Add event listeners to status badge
function addStatusBadgeListeners(badge) {
    const dropdown = badge.querySelector('.status-dropdown');
    const options = dropdown.querySelectorAll('.status-option');
    
    badge.addEventListener('click', function(e) {
        e.stopPropagation();
        toggleStatusDropdown(this);
    });
    
    options.forEach(option => {
        option.addEventListener('click', function(e) {
            e.stopPropagation();
            updateStatus(badge, this.dataset.status, this);
        });
    });
}



// Toggle dropdown visibility
function toggleStatusDropdown(badge) {
    const dropdown = badge.querySelector('.status-dropdown');
    if (!dropdown) return;
    
    const isOpen = dropdown.classList.contains('show');
    
    // Close all other dropdowns
    closeAllStatusDropdowns();
    
    // Toggle current dropdown
    if (!isOpen) {
        dropdown.classList.add('show');
    }
}

// Close all dropdowns
function closeAllStatusDropdowns() {
    const dropdowns = document.querySelectorAll('.status-dropdown');
    dropdowns.forEach(dropdown => {
        dropdown.classList.remove('show');
    });
}




// Update status via API
async function updateStatus(badge, newStatus, optionElement) {
    try {
        const jobId = badge.dataset.jobId;
        if (!jobId) {
            console.error('Job ID not found');
            showStatusNotification('Job ID tidak ditemukan', 'error');
            return;
        }
        
        console.log(`Updating job ${jobId} status to: ${newStatus}`);
        
        // Store original content before loading
        const originalContent = badge.innerHTML;
        const originalClasses = badge.className;
        
        // Show loading state immediately
        badge.innerHTML = `
            <div class="status-loading">
                <div class="spinner"></div>
                Mengupdate...
            </div>
        `;
        badge.style.opacity = '0.7';
        badge.style.pointerEvents = 'none';
        
        // Close dropdown immediately
        const dropdown = badge.querySelector('.status-dropdown');
        if (dropdown) dropdown.classList.remove('show');
        
        // Make API call
        const response = await fetch(`/api/job/${jobId}/status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ status: newStatus })
        });
        
        const data = await response.json();
        console.log('API Response:', data);
        



        if (response.ok && data.success) {
            // Update badge appearance with new status
            const statusClass = newStatus.toLowerCase().replace(/\s+/g, '-');
            const newClassName = `status-badge status-${statusClass}`;
            
            console.log('Updating badge from:', badge.className, 'to:', newClassName);
            
            // Remove all status-* classes first
            const classList = badge.className.split(' ').filter(cls => !cls.startsWith('status-'));
            
            // Set base class and new status class
            badge.className = `status-badge status-${statusClass}`;
            badge.innerHTML = `
                <i class="fas fa-flag"></i>
                ${newStatus}
            `;
            badge.style.opacity = '1';
            badge.style.pointerEvents = 'auto';
            
            // Force a reflow to ensure CSS updates
            badge.offsetHeight;
            
            console.log(`Badge updated successfully. Final classes: ${badge.className}`);
            
            // Update dropdown options to show new active state
            setTimeout(() => {
                updateDropdownOptions(badge, newStatus);
            }, 100);
            
            // Update statistics if available
            if (data.stats) {
                updateStatistics(data.stats);
            }
            

            // Show success notification
            showStatusNotification('Status berhasil diupdate!', 'success');
            
            // ðŸš€ TRIGGER REAL-TIME NOTIFICATION UPDATE
            // Reload notifications to show the new status update notification at the top
            if (typeof loadNotifications === 'function') {
                loadNotifications();
            }
            
            // Force update notification badge
            if (typeof updateNotificationBadge === 'function') {
                updateNotificationBadge();
            }
            
            // Update notification relative time immediately
            if (typeof updateNotificationRelativeTime === 'function') {
                updateNotificationRelativeTime();
            }
            
        } else {
            throw new Error(data.message || 'Gagal mengupdate status');
        }
        
    } catch (error) {
        console.error('Error updating status:', error);
        const errorMessage = error.message || 'Terjadi kesalahan saat mengupdate status';
        
        // Restore original content on error
        badge.innerHTML = originalContent;
        badge.className = originalClasses;
        badge.style.opacity = '1';
        badge.style.pointerEvents = 'auto';
        
        // Show error notification
        showStatusNotification(errorMessage, 'error');
    }
}


// Show loading state
function showStatusLoading(badge) {
    const originalContent = badge.innerHTML;
    const originalClasses = badge.className;
    
    badge.setAttribute('data-original-content', originalContent);
    badge.setAttribute('data-original-classes', originalClasses);
    badge.innerHTML = `
        <div class="status-loading">
            <div class="spinner"></div>
            Mengupdate...
        </div>
    `;
    badge.style.pointerEvents = 'none';
    badge.style.opacity = '0.7';
}

// Hide loading state
function hideStatusLoading(badge) {
    const originalContent = badge.getAttribute('data-original-content');
    const originalClasses = badge.getAttribute('data-original-classes');
    
    if (originalContent) {
        badge.innerHTML = originalContent;
        badge.removeAttribute('data-original-content');
    }
    
    if (originalClasses) {
        badge.className = originalClasses;
        badge.removeAttribute('data-original-classes');
    }
    
    badge.style.pointerEvents = 'auto';
    badge.style.opacity = '1';
}

// Update badge appearance
function updateStatusBadge(badge, newStatus) {
    // Remove all status-related classes
    const baseClasses = 'status-badge';
    badge.className = baseClasses;
    
    // Add new status class
    const statusClass = newStatus.toLowerCase().replace(/\s+/g, '-');
    badge.classList.add(`status-${statusClass}`);
    
    // Update content
    badge.innerHTML = `
        <i class="fas fa-flag"></i>
        ${newStatus}
    `;
    
    console.log(`Updated badge class to: status-${statusClass}`);
}

// Update dropdown options
function updateDropdownOptions(badge, newStatus) {
    const dropdown = badge.querySelector('.status-dropdown');
    const options = dropdown.querySelectorAll('.status-option');
    
    options.forEach(option => {
        option.classList.remove('active');
        if (option.dataset.status === newStatus) {
            option.classList.add('active');
        }
    });
}

// Update statistics cards
function updateStatistics(stats) {
    Object.keys(stats).forEach(key => {
        const statElement = document.querySelector(`[data-stat="${key}"]`);
        if (statElement) {
            statElement.textContent = stats[key];
        }
    });
}

// Close all dropdowns
function closeAllStatusDropdowns() {
    const dropdowns = document.querySelectorAll('.status-dropdown');
    dropdowns.forEach(dropdown => {
        dropdown.classList.remove('show');
    });
}





// Enhanced notification system
function showStatusNotification(message, type = 'success') {
    // Use existing showAlert if available
    if (window.showAlert) {
        window.showAlert(message, type);
        return;
    }
    
    // Fallback to simple alert
    const alertClass = type === 'error' ? 'alert-danger' : 'alert-success';
    const icon = type === 'error' ? 'fas fa-exclamation-triangle' : 'fas fa-check-circle';
    
    // Create temporary alert
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert ${alertClass} alert-dismissible fade show`;
    alertDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        max-width: 400px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        animation: slideInRight 0.3s ease-out;
    `;
    
    alertDiv.innerHTML = `
        <i class="${icon} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Auto remove after 4 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.style.animation = 'slideOutRight 0.3s ease-in';
            setTimeout(() => alertDiv.remove(), 300);
        }
    }, 4000);
}

// Close dropdowns when clicking outside
document.addEventListener('click', function(event) {
    const isStatusBadge = event.target.closest('.status-badge');
    const isDropdown = event.target.closest('.status-dropdown');
    
    if (!isStatusBadge && !isDropdown) {
        closeAllStatusDropdowns();
    }
});



// Close modal with Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeAllStatusDropdowns();
    }
});

// Initialize relative time formatting
function initializeRelativeTime() {
    const updateElements = document.querySelectorAll('.last-update-text');
    
    updateElements.forEach(element => {
        const timestamp = element.dataset.timestamp;
        if (timestamp) {
            const relativeTime = formatRelativeTime(timestamp);
            element.textContent = relativeTime;
            element.title = new Date(timestamp).toLocaleString('id-ID');
        }
    });
    
    // Update relative times every minute
    setInterval(() => {
        updateElements.forEach(element => {
            const timestamp = element.dataset.timestamp;
            if (timestamp) {
                const relativeTime = formatRelativeTime(timestamp);
                element.textContent = relativeTime;
            }
        });
    }, 60000); // Update every minute
}



// Format relative time in Indonesian - ULTRA GRANULAR with seconds precision
function formatRelativeTime(timestamp) {
    const now = new Date();
    const updateTime = new Date(timestamp);
    const diffInSeconds = Math.floor((now - updateTime) / 1000);
    const diffInMinutes = Math.floor(diffInSeconds / 60);
    const diffInHours = Math.floor(diffInMinutes / 60);
    const diffInDays = Math.floor(diffInHours / 24);
    
    // ULTRA-RECENT: Less than 10 seconds
    if (diffInSeconds < 10) {
        return 'Baru saja';
    }
    
    // RECENT: 10 seconds to 59 seconds  
    if (diffInSeconds < 60) {
        return `${diffInSeconds} detik yang lalu`;
    }
    
    // MINUTE RANGE: 1 minute to 59 minutes 59 seconds
    if (diffInMinutes < 60) {
        const minutes = diffInMinutes;
        const seconds = diffInSeconds % 60;
        
        // Show seconds only if less than 5 minutes
        if (minutes < 5) {
            if (seconds > 0) {
                return `${minutes} menit ${seconds} detik yang lalu`;
            } else {
                return `${minutes} menit yang lalu`;
            }
        } else {
            return `${minutes} menit yang lalu`;
        }
    }
    
    // HOUR RANGE: 1 hour to 23 hours 59 minutes
    if (diffInHours < 24) {
        const hours = diffInHours;
        const remainingMinutes = diffInMinutes % 60;
        
        // Show detailed breakdown for first few hours
        if (hours < 3) {
            if (remainingMinutes > 0) {
                return `${hours} jam ${remainingMinutes} menit yang lalu`;
            } else {
                return `${hours} jam yang lalu`;
            }
        } else {
            return `${hours} jam yang lalu`;
        }
    }
    
    // DAY RANGE: 1 day to 6 days 23 hours
    if (diffInDays < 7) {
        const days = diffInDays;
        const remainingHours = diffInHours % 24;
        
        if (days === 1 && remainingHours > 0) {
            return `${days} hari ${remainingHours} jam yang lalu`;
        } else {
            return `${days} hari yang lalu`;
        }
    }
    
    // WEEK RANGE: 1 week to 4 weeks 6 days
    if (diffInDays < 30) {
        const weeks = Math.floor(diffInDays / 7);
        const remainingDays = diffInDays % 7;
        
        if (weeks === 1 && remainingDays > 0) {
            return `${weeks} minggu ${remainingDays} hari yang lalu`;
        } else {
            return `${weeks} minggu yang lalu`;
        }
    }
    
    // MONTH RANGE: 1 month to 11 months 29 days
    const diffInMonths = Math.floor(diffInDays / 30);
    if (diffInMonths < 12) {
        const months = diffInMonths;
        const remainingDays = diffInDays % 30;
        
        if (months === 1 && remainingDays > 0) {
            return `${months} bulan ${remainingDays} hari yang lalu`;
        } else {
            return `${months} bulan yang lalu`;
        }
    }
    
    // YEAR RANGE: 1 year and beyond
    const diffInYears = Math.floor(diffInDays / 365);
    if (diffInYears >= 1) {
        const years = diffInYears;
        const remainingMonths = Math.floor((diffInDays % 365) / 30);
        
        if (years === 1 && remainingMonths > 0) {
            return `${years} tahun ${remainingMonths} bulan yang lalu`;
        } else {
            return `${years} tahun yang lalu`;
        }
    }
    
    // FALLBACK: Show exact date for very old timestamps
    return updateTime.toLocaleDateString('id-ID', {
        day: 'numeric',
        month: 'short', 
        year: updateTime.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
    });
}
</script>

{% endblock %}

